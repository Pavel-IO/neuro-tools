<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <title>ROIs coverage checker</title>

        <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">

        <link href="styles.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
        <script type="text/javascript" src="scripts.js"></script>
    </head>
    <body>
        <script type="text/javascript" src="table_data.js"></script>

        <div class="container-fluid">
            <div class="row">
                <div class="col-6">
                    <p id="subjsDisplayExcluded"></p>
                    <br>
                    <p id="roisDisplayExcluded"></p>
                    <div>
                        <p>Show stats:
                            <input type="radio" name="show" id="show_rois"> <label for="show_rois">Rois</label>
                            <input type="radio" name="show" id="show_subjs"> <label for="show_subjs">Subjs</label>
                            <input type="radio" name="show" id="show_none"> <label for="show_none">None</label>
                        </p>
                    </div>
                </div>
                <div class="col">
                    <div class="itemsContainer">
                        <p id="subjsCheckboxes"><b>Subjects:</b><br></p>
                    </div>
                </div>
                <div class="col">
                    <div class="itemsContainer">
                        <p id="roisCheckboxes"><b>Rois:</b><br></p>
                    </div>
                </div>
            </div>
        </div>

        <hr>
        <div id="statsTablePanel" style="width:38%; display: inline-block;"></div>
        <div id="mainTablePanel" style="width:60%; display: inline-block;"></div>

    <script>
        var cellFormater = (cell, formatterParams) => {
            var value = cell.getValue()
            if (Number.isInteger(value)){
                let color = ''
                if (value < 25) {
                    color = 'red'
                } else if (value < 50) {
                    color = '#ff9e44'
                }
                if (color) {
                    return '<span style="color:' + color + '; font-weight:bold;">' + value + "</span>"
                } else {
                    return value
                }
            } else {
                return value
            }
        }

        var dataModel = new DataModel()     // TODO: model si nacte data, bude je filtrovat a vracet pro zobrazeni
                                            //       krome toho poskytne vedlejsi vystupy, jako treba seznam subjs a rois pro UI

        var excluded = []

        function updatedExcluded() {
            document.getElementById('subjsDisplayExcluded').innerText = 'Excluded subjects: ' + excluded.join(', ')
        }
        updatedExcluded()

        var subjectsChecksListener = (event) => {
            let value = event.target.value
            let checked = event.target.checked
            let index = excluded.indexOf(value)
            // tahle slozitost resi situaci, ktera by vlastne nemela nikdy nastat...
            // ale nektere prohlizece si pamatuji nastaveni formularu pred F5
            if (checked) {
                if (index >= 0) {
                    excluded = removeItem(excluded, index)
                }
            } else {
                if (index < 0) {
                    excluded.push(value)
                }
            }
            excluded.sort()
            updatedExcluded()
            updateMainTable()
        }

        // --------------------- subjs ------------------------
        let subjs = dataModel.getAllSubjNames()
        for (let k = 0; k < subjs.length; k++) {
            let html = '<input type="checkbox" id="subj' + k + '" value="' + subjs[k] + '"> <label for="subj' + k + '">' + subjs[k] + '</label><br>'
            document.getElementById('subjsCheckboxes').innerHTML += html
        }
        // toto nemuze byt v jednom cyklu, dokud se appenduji html a furt ho prepisuji, mazu si event listenery
        for (let k = 0; k < subjs.length; k++) {
            let obj = document.getElementById('subj' + k)
            obj.checked = true
            obj.onchange = subjectsChecksListener
        }

        // --------------------- rois ------------------------
        let rois = dataModel.getAllRoiNames()
        for (let k = 0; k < rois.length; k++) {
            let html = '<input type="checkbox" id="roi' + k + '" value="' + rois[k] + '"> <label for="roi' + k + '">' + rois[k] + '</label><br>'
            document.getElementById('roisCheckboxes').innerHTML += html
        }

        // --------------------- stats ------------------------
        let showOnlyMainTable = () => {
            document.getElementById('statsTablePanel').style.display = 'none'
            document.getElementById('mainTablePanel').style.width = '98%'
        }

        let showStatsAndMainTable = () => {
            document.getElementById('statsTablePanel').style.display = 'inline-block'
            document.getElementById('mainTablePanel').style.width = '60%'
        }

        let updateStatsListener = () => {
            let showRois = document.getElementById('show_rois').checked
            let showSubjs = document.getElementById('show_subjs').checked
            if (showRois) {
                showStatsAndMainTable()
                updateStatsTable(calculateRoisStatsTable())
            } else if (showSubjs) {
                showStatsAndMainTable()
                updateStatsTable(calculateSubjsStatsTable())
            } else {
                showOnlyMainTable()
            }

        }
        let statsControls = ['show_rois', 'show_subjs', 'show_none']
        document.getElementById('show_rois').checked = true
        for (let control of statsControls) {
            document.getElementById(control).onchange = updateStatsListener
        }

        function calculateRoisStatsTable() {
            let roisStat = []
            let filteredDataset = dataModel.getFilteredData()
            for (column of dataModel.getFilteredColumns()) {
                if (column.field == 'name') {
                    continue
                }

                let subjsRoiValues = []
                for (let subject of filteredDataset) {
                    subjsRoiValues.push(subject[column.field])
                }

                let stats = new Stats
                lineRecord = {}
                lineRecord.roi = column.title
                lineRecord.mean = Math.round(stats.mean(subjsRoiValues))
                lineRecord.min = Math.round(stats.min(subjsRoiValues))
                lineRecord.q10 = Math.round(stats.quantile(subjsRoiValues, 0.10))
                lineRecord.q25 = Math.round(stats.quantile(subjsRoiValues, 0.25))
                roisStat.push(lineRecord)
            }

            var roisStatColumns = [
                {title: 'Roi', field: 'roi', width: 200, frozen:true},
                {title: 'Minimum', field: 'min', formatter: cellFormater},
                {title: 'Decile', field: 'q10', formatter: cellFormater},
                {title: 'Quartile', field: 'q25', formatter: cellFormater},
                {title: 'Mean', field: 'mean', formatter: cellFormater},
            ]
            return {data: roisStat, columns: roisStatColumns}
        }

        function calculateSubjsStatsTable() {
            let subjsStat = []
            let filteredDataset = dataModel.getFilteredData()
            let filteredColumns = dataModel.getFilteredColumns()
            for (subjRecord of filteredDataset) {

                let roisSubjValues = []
                for (let column of filteredColumns) {
                    if (column.field == 'name') {
                        continue
                    }
                    roisSubjValues.push(subjRecord[column.field])
                }

                let stats = new Stats
                lineRecord = {}
                lineRecord.roi = subjRecord.name
                lineRecord.mean = Math.round(stats.mean(roisSubjValues))
                lineRecord.min = Math.round(stats.min(roisSubjValues))
                lineRecord.q10 = Math.round(stats.quantile(roisSubjValues, 0.10))
                lineRecord.q25 = Math.round(stats.quantile(roisSubjValues, 0.25))
                subjsStat.push(lineRecord)
            }

            var subjsStatColumns = [
                {title: 'Subj', field: 'roi', width:200, frozen:true},
                {title: 'Minimum', field: 'min', formatter: cellFormater},
                {title: 'Decile', field: 'q10', formatter: cellFormater},
                {title: 'Quartile', field: 'q25', formatter: cellFormater},
                {title: 'Mean', field: 'mean', formatter: cellFormater},
            ]
            return {data: subjsStat, columns: subjsStatColumns}
        }

        var table = new Tabulator("#mainTablePanel", {
            data: dataModel.getFilteredData(),
            height: '600px',
            columns: dataModel.getFilteredColumns(),
            rowFormatter: (row) => {
                if(row.getData().col < 50) {
                    row.getElement().style.backgroundColor = "#ff0000"
                }
            },
        })

        function updateMainTable() {
            table.replaceData(dataModel.getFilteredData())
        }

        // columns manipulations: http://tabulator.info/docs/4.5/columns
        // table.setColumns(), table.deleteColumn(), table.addColumn()

        var roiStatsTable = calculateRoisStatsTable()
        var statsTable = new Tabulator("#statsTablePanel", {
            data: roiStatsTable.data,
            height: '600px',
            columns: roiStatsTable.columns,
        })

        function updateStatsTable(newDataset) {
            statsTable.setColumns(newDataset.columns)
            statsTable.replaceData(newDataset.data)
        }

    </script>
    </body>
</html>
